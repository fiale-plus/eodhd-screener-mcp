name: ðŸ§ª Test Pull Request

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/**'

env:
  EODHD_API_KEY: demo  # Using demo key for PR tests

jobs:
  test:
    name: ðŸ” Regression Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd tests && npm ci

      - name: ðŸ—ï¸ Build MCP server
        run: npm run build

      - name: ðŸ” TypeScript type check
        run: |
          npx tsc --noEmit
          cd tests && npm run test:build

      - name: ðŸ§ª Run regression tests
        run: |
          echo "ðŸš€ Running EODHD MCP regression tests..."
          cd tests && timeout 120 npm test || {
            echo "âŒ Tests failed or timed out"
            exit 1
          }

      - name: ðŸ“Š Test results summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **EODHD API**: Demo key (limited)" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: Regression suite for context overflow prevention" >> $GITHUB_STEP_SUMMARY

          if [ $? -eq 0 ]; then
            echo "- **Status**: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âŒ FAILED" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” TypeScript check
        run: npx tsc --noEmit

      - name: ðŸ§¹ Check formatting (if prettier configured)
        continue-on-error: true
        run: |
          if [ -f ".prettierrc" ] || [ -f "prettier.config.js" ]; then
            npx prettier --check .
          else
            echo "â­ï¸ Prettier not configured, skipping"
          fi

  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ”’ Security audit
        run: |
          npm audit --audit-level=moderate
          cd tests && npm audit --audit-level=moderate

  summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: always()

    steps:
      - name: ðŸ“‹ Create PR summary
        run: |
          echo "## ðŸ§ª EODHD MCP Server - PR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Regression Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Tests context window overflow prevention" >> $GITHUB_STEP_SUMMARY
          echo "- Validates dynamic defaults (period Ã— 1.5)" >> $GITHUB_STEP_SUMMARY
          echo "- Checks RSI200/SMA200 functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Verifies all 4 MCP tools available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "âœ… **Regression Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Regression Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.lint.result }}" == "success" ]]; then
            echo "âœ… **Code Quality**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.security.result }}" == "success" ]]; then
            echo "âœ… **Security**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security**: ISSUES FOUND" >> $GITHUB_STEP_SUMMARY
          fi