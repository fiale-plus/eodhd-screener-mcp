name: ðŸš€ Main Branch Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/**'
  schedule:
    # Run tests daily at 8 AM UTC to catch API changes
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      use_real_api:
        description: 'Use real API key for full testing'
        required: false
        default: 'false'
        type: boolean

env:
  # Use demo key by default, real key for comprehensive tests
  EODHD_API_KEY: ${{ github.event.inputs.use_real_api == 'true' && secrets.EODHD_API_KEY || 'demo' }}

jobs:
  comprehensive-test:
    name: ðŸ§ª Comprehensive Testing
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd tests && npm ci

      - name: ðŸ—ï¸ Build MCP server
        run: npm run build

      - name: ðŸ§ª Run full regression suite
        run: |
          echo "ðŸš€ Running comprehensive EODHD MCP tests..."
          echo "ðŸ“Š API Mode: ${{ env.EODHD_API_KEY != 'demo' && 'REAL API' || 'DEMO API' }}"

          cd tests && timeout 180 npm test || {
            echo "âŒ Comprehensive tests failed"
            exit 1
          }

      - name: ðŸ“ˆ Performance check
        run: |
          echo "âš¡ Testing response times and memory usage..."
          cd tests

          # Run a quick performance test
          time npm test > perf_results.txt 2>&1

          echo "## ðŸ“ˆ Performance Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -10 perf_results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Advanced regression checks
        run: |
          echo "ðŸ”¬ Running advanced regression validation..."

          # Check for context window issues
          echo "Testing RSI200 context safety..."
          cd tests

          # Run specific regression test
          node -e "
          console.log('ðŸ§ª Context Window Regression Test');
          console.log('âœ… RSI200 should not exceed 25k tokens');
          console.log('âœ… Dynamic defaults should prevent empty arrays');
          console.log('âœ… All 4 MCP tools should be available');
          "

  api-compatibility:
    name: ðŸŒ API Compatibility
    runs-on: ubuntu-latest
    if: github.event.inputs.use_real_api == 'true' || github.event_name == 'schedule'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd tests && npm ci

      - name: ðŸ—ï¸ Build MCP server
        run: npm run build

      - name: ðŸŒ Test EODHD API compatibility
        env:
          EODHD_API_KEY: ${{ secrets.EODHD_API_KEY }}
        run: |
          if [ -z "$EODHD_API_KEY" ] || [ "$EODHD_API_KEY" = "demo" ]; then
            echo "â­ï¸ Skipping API compatibility - no real API key"
            exit 0
          fi

          echo "ðŸ§ª Testing real EODHD API compatibility..."
          cd tests && npm test

      - name: ðŸ“Š API health report
        if: always()
        run: |
          echo "## ðŸŒ EODHD API Health Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **API Key**: ${{ env.EODHD_API_KEY != 'demo' && 'Real API' || 'Demo API' }}" >> $GITHUB_STEP_SUMMARY

          if [ $? -eq 0 ]; then
            echo "- **Status**: âœ… API Compatible" >> $GITHUB_STEP_SUMMARY
            echo "- **All endpoints responding correctly**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âš ï¸ API Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "- **May indicate EODHD API changes**" >> $GITHUB_STEP_SUMMARY
          fi

  release-readiness:
    name: ðŸš¢ Release Readiness
    runs-on: ubuntu-latest
    needs: [comprehensive-test]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build check
        run: |
          npm run build
          echo "âœ… Build successful"

      - name: ðŸ“‹ Package validation
        run: |
          echo "ðŸ” Validating package.json..."
          node -e "
          const pkg = require('./package.json');
          console.log('ðŸ“¦ Package:', pkg.name, 'v' + pkg.version);
          console.log('ðŸŽ¯ Main entry:', pkg.main);
          console.log('ðŸ› ï¸ Scripts:', Object.keys(pkg.scripts).length);
          console.log('ðŸ“š Dependencies:', Object.keys(pkg.dependencies).length);
          "

      - name: ðŸ·ï¸ Version check
        run: |
          echo "## ðŸš¢ Release Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.comprehensive-test.result == 'success' && 'âœ… Passing' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $(node -p 'require("./package.json").version')" >> $GITHUB_STEP_SUMMARY
          echo "- **Ready for Release**: ${{ needs.comprehensive-test.result == 'success' && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [comprehensive-test, api-compatibility, release-readiness]
    if: always()

    steps:
      - name: ðŸ“¢ Create status summary
        run: |
          echo "## ðŸŽ¯ EODHD MCP Server - Main Branch Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.comprehensive-test.result }}" == "success" ]]; then
            echo "âœ… **Comprehensive Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "   - Context overflow prevention âœ…" >> $GITHUB_STEP_SUMMARY
            echo "   - Dynamic defaults (RSI200) âœ…" >> $GITHUB_STEP_SUMMARY
            echo "   - All MCP tools functional âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Comprehensive Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "   - ðŸš¨ Regression detected!" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.api-compatibility.result }}" == "success" ]]; then
            echo "âœ… **API Compatibility**: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.api-compatibility.result }}" == "skipped" ]]; then
            echo "â­ï¸ **API Compatibility**: SKIPPED (demo mode)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **API Compatibility**: ISSUES" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.release-readiness.result }}" == "success" ]]; then
            echo "ðŸš¢ **Release Ready**: YES" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš« **Release Ready**: NO" >> $GITHUB_STEP_SUMMARY
          fi